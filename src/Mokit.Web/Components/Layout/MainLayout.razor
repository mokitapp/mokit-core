@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Mokit.Domain.Entities
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager

<AuthorizeView>
    <Authorized>
        @{
            var themeClass = userTheme == "light" ? "light-theme" : "";
            var sidebarClass = userSidebarCollapsed ? "sidebar-collapsed" : "";
        }
        <!-- Full Layout for Authenticated Users -->
        <div class="layout-wrapper @themeClass @sidebarClass" data-sidebar="@(userSidebarCollapsed ? "collapsed" : "expanded")">
            <div class="app-container @sidebarClass">
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <div class="logo">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                                <path d="M8 12L16 8L24 12V20L16 24L8 20V12Z" stroke="white" stroke-width="2" fill="none"/>
                                <circle cx="16" cy="16" r="3" fill="white"/>
                                <defs>
                                    <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                        <stop offset="0%" stop-color="#6366f1"/>
                                        <stop offset="100%" stop-color="#8b5cf6"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <span class="logo-text">Mokit</span>
                        </div>
                    </div>
                    <NavMenu />
                </aside>

                <main class="main-content">
                    <header class="top-header">
                        <div class="header-left">
                            <button type="button" class="btn-icon" title="Toggle sidebar" onclick="toggleSidebar()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="3" y1="6" x2="21" y2="6"/>
                                    <line x1="3" y1="12" x2="21" y2="12"/>
                                    <line x1="3" y1="18" x2="21" y2="18"/>
                                </svg>
                            </button>
                        </div>
                        <div class="header-right">
                            <button type="button" class="btn-icon theme-toggle" title="Toggle Theme" onclick="toggleTheme()">
                                @if (userTheme == "light")
                                {
                                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="5"/>
                                        <line x1="12" y1="1" x2="12" y2="3"/>
                                        <line x1="12" y1="21" x2="12" y2="23"/>
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                        <line x1="1" y1="12" x2="3" y2="12"/>
                                        <line x1="21" y1="12" x2="23" y2="12"/>
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                    </svg>
                                }
                            </button>
                        </div>
                    </header>

                    <div class="content-area">
                        @Body
                    </div>
                </main>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <!-- Minimal Layout for Login/Setup -->
        <div class="minimal-layout">
            @Body
        </div>
    </NotAuthorized>
</AuthorizeView>

<div id="blazor-error-ui" data-nosnippet>
    An error occurred while loading the application.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">??</a>
</div>

<Mokit.Web.Components.Shared.ToastContainer />

@code {
    private string userTheme = "dark";
    private bool userSidebarCollapsed = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                userTheme = appUser.ThemePreference ?? "dark";
                userSidebarCollapsed = appUser.SidebarCollapsed;
            }
        }
    }
}

<style>
    .minimal-layout {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
    }
    
    .theme-toggle {
        transition: transform 0.3s ease;
    }
    
    .theme-toggle:hover {
        transform: rotate(15deg);
    }
    
    /* Theme icons */
    .theme-toggle svg {
        stroke: var(--text-primary);
    }
    
    .theme-toggle .sun-icon {
        color: #fbbf24;
        stroke: #fbbf24;
    }
    
    .theme-toggle .moon-icon {
        color: #6366f1;
        stroke: #6366f1;
    }
</style>
