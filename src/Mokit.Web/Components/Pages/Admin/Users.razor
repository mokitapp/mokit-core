@page "/Admin/Users"
@rendermode InteractiveServer
@using Mokit.Application.DTOs.User
@using Mokit.Application.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IUserService UserService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>User Management - Mokit</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">User Management</h1>
        <p class="page-description">Manage system users</p>
    </div>
    <a href="/Admin/Users/New" class="btn btn-primary">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <line x1="19" y1="8" x2="19" y2="14"/>
            <line x1="22" y1="11" x2="16" y2="11"/>
        </svg>
        Add User
    </a>
</div>

@if (!isAdmin)
{
    <div class="alert alert-danger">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        You do not have access to this page.
    </div>
}
else if (loading)
{
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(Success))
    {
        <div class="alert alert-success mb-4">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            @Success
        </div>
    }

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">All Users (@users.Count)</h3>
        </div>
        
        @if (users.Any())
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Teams</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        @(user.FullName.Length > 0 ? user.FullName.Substring(0, 1).ToUpper() : "?")
                                    </div>
                                    <span class="user-name">@user.FullName</span>
                                </div>
                            </td>
                            <td>@user.Email</td>
                            <td>
                                @if (user.IsAdmin)
                                {
                                    <span class="badge badge-primary">Admin</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">User</span>
                                }
                            </td>
                            <td>
                                @if (user.Teams.Any())
                                {
                                    <div class="team-badges">
                                        @foreach (var team in user.Teams.Take(3))
                                        {
                                            <span class="badge badge-outline">@team.TeamName</span>
                                        }
                                        @if (user.Teams.Count > 3)
                                        {
                                            <span class="badge badge-outline">+@(user.Teams.Count - 3)</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge badge-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge badge-danger">Disabled</span>
                                }
                            </td>
                            <td>
                                @if (user.LastLoginAt.HasValue)
                                {
                                    <span class="text-muted">@user.LastLoginAt.Value.ToString("dd.MM.yyyy HH:mm")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Never logged in</span>
                                }
                            </td>
                            <td>
                                <a href="/Admin/Users/@user.Id" class="btn btn-sm btn-outline">Edit</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">
                <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <div class="empty-state-title">No users yet</div>
                <p>Add your first user</p>
                <a href="/Admin/Users/New" class="btn btn-primary mt-4">Add User</a>
            </div>
        }
    </div>
}

<style>
    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .user-name {
        font-weight: 500;
    }

    .team-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .badge-outline {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-muted);
    }

    .alert-success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 8px;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        padding: 4rem;
    }
</style>

@code {
    [SupplyParameterFromQuery]
    public string? Success { get; set; }

    private List<UserDto> users = new();
    private bool loading = true;
    private bool isAdmin = false;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(currentUserId))
        {
            Navigation.NavigateTo("/Account/Login");
            return;
        }

        isAdmin = await UserService.IsAdminAsync(currentUserId);

        if (isAdmin)
        {
            var result = await UserService.GetAllUsersAsync();
            if (result.IsSuccess)
            {
                users = result.Data ?? new();
            }
        }

        loading = false;
    }
}
