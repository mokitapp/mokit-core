@page "/Admin/Users/{UserId}"
@rendermode InteractiveServer
@using Mokit.Application.DTOs.User
@using Mokit.Application.DTOs.Team
@using Mokit.Application.Interfaces
@using Mokit.Application.Constants
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>@(user?.FullName ?? "User") - Mokit</PageTitle>

<div class="page-header">
    <div>
        <div class="breadcrumb">
            <a href="/Admin/Users" class="btn btn-sm btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
            </a>
        </div>
        <h1 class="page-title">@(user?.FullName ?? "User Details")</h1>
        <p class="page-description">@user?.Email</p>
    </div>
</div>

@if (!isAdmin)
{
    <div class="alert alert-danger">
        You do not have permission to access this page.
    </div>
}
else if (loading)
{
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
}
else if (user == null)
{
    <div class="alert alert-danger">
        User not found.
    </div>
}
else
{
    <div class="content-grid">
        <div class="main-content">
            <!-- User Info Card -->
            <div class="card mb-4">
                <h3 class="card-title">User Information</h3>
                
                <div class="user-profile">
                    <div class="user-avatar-large">
                        @(user.FullName.Length > 0 ? user.FullName.Substring(0, 1).ToUpper() : "?")
                    </div>
                    <div class="user-details">
                        <h2>@user.FullName</h2>
                        <p>@user.Email</p>
                        <div class="user-badges">
                            @if (user.IsAdmin)
                            {
                                <span class="badge badge-primary">Admin</span>
                            }
                            @if (user.IsActive)
                            {
                                <span class="badge badge-success">Active</span>
                            }
                            else
                            {
                                <span class="badge badge-danger">Inactive</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Registered At</span>
                        <span class="info-value">@user.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Login</span>
                        <span class="info-value">
                            @if (user.LastLoginAt.HasValue)
                            {
                                @user.LastLoginAt.Value.ToString("dd.MM.yyyy HH:mm")
                            }
                            else
                            {
                                <text>Never logged in</text>
                            }
                        </span>
                    </div>
                </div>

                <div class="action-buttons">
                    @if (user.IsActive)
                    {
                        <button class="btn btn-outline btn-danger" @onclick="PromptDeactivateUser">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            Deactivate
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-outline btn-success" @onclick="PromptReactivateUser">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Activate
                        </button>
                    }
                </div>
            </div>

            <!-- Team Memberships -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Team Memberships</h3>
                    <button class="btn btn-sm btn-primary" @onclick="() => showAddTeamModal = true">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add to Team
                    </button>
                </div>

                @if (user.Teams.Any())
                {
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Role</th>
                                <th>Joined At</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var team in user.Teams)
                            {
                                <tr>
                                    <td>
                                        <a href="/teams/@team.TeamId">@team.TeamName</a>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">@GetRoleDisplayName(team.Role)</span>
                                    </td>
                                    <td>@team.JoinedAt.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline btn-danger" @onclick="() => PromptRemoveFromTeam(team.TeamId)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-state-small">
                        <p>This user is not a member of any team.</p>
                    </div>
                }
            </div>
        </div>

        <div class="sidebar">
            <!-- Reset Password Card -->
            <div class="card">
                <h3 class="card-title">Reset Password</h3>
                <form method="post" action="/api/account/reset-password">
                    <input type="hidden" name="UserId" value="@user.Id" />
                    
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" name="NewPassword" class="form-control" placeholder="••••••••" required />
                    </div>

                    <button type="submit" class="btn btn-outline btn-block">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0110 0v4"/>
                        </svg>
                        Reset Password
                    </button>
                </form>
            </div>

            <!-- Toggle Admin Card -->
            <div class="card">
                <h3 class="card-title">Admin Privileges</h3>
                <p class="text-muted mb-4">
                    @if (user.IsAdmin)
                    {
                        <text>This user has admin privileges.</text>
                    }
                    else
                    {
                        <text>This user is a regular user.</text>
                    }
                </p>
                <button class="btn btn-outline btn-block" @onclick="PromptToggleAdmin">
                    @if (user.IsAdmin)
                    {
                        <text>Revoke Admin Access</text>
                    }
                    else
                    {
                        <text>Grant Admin Access</text>
                    }
                </button>
            </div>
        </div>
    </div>

    <!-- Add to Team Modal -->
    @if (showAddTeamModal)
    {
        <div class="modal-backdrop" @onclick="() => showAddTeamModal = false">
            <div class="modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Add to Team</h3>
                    <button class="modal-close" @onclick="() => showAddTeamModal = false">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Select Team</label>
                        <select class="form-control" @bind="selectedTeamId">
                            <option value="">-- Select Team --</option>
                            @foreach (var team in availableTeams)
                            {
                                <option value="@team.Id">@team.Name</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-control" @bind="selectedRole">
                            <option value="@RoleConstants.Member">Member</option>
                            <option value="@RoleConstants.Admin">Team Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" @onclick="() => showAddTeamModal = false">Cancel</button>
                    <button class="btn btn-primary" @onclick="AddToTeam">Add</button>
                </div>
            </div>
        </div>
    }

    <Mokit.Web.Components.Shared.ConfirmationModal 
        IsVisible="@showConfirmation" 
        Title="@confirmationTitle" 
        Message="@confirmationMessage" 
        OnConfirm="ExecuteConfirmedAction" 
        OnCancel="CancelConfirmation" />
}
